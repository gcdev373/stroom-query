task wrapper(type: Wrapper) {
    gradleVersion = '4.1'
}

// If the project has a value for the passed property (i.e from the cmd line via -PpropName=xxx) use that, else use a default value.
ext.getPropertyOrDefault = { propName, defaultValue ->
    return project.hasProperty(propName) ?
            project.getProperty(propName) :
            defaultValue
}

ext.versions = [
    //----------Stroom-----------------
    stroomQuery: getPropertyOrDefault('version', 'SNAPSHOT'),

    //------Stroom-repos---------------
    stroomExpression: 'v1.0.0',
    eventLogging: 'v3.1.1_schema-v3.1.2',

    //------------3rd-party------------
    dropwizard: '1.2.0',
    jackson: '2.8.6',
    kafka: '0.10.0.1',
    slf4j: '1.7.24', //in line with dropwizard 1.1.0
    swagger: '1.5.16',
    zzDUMMYzz: 'makes sorting this list easier'
]

//lib names for urlDependenciesPlugin
ext.urlLibs = [
    stroomExpression: "stroom-expression-$versions.stroomExpression",
    eventLogging: "event-logging-$versions.eventLogging",
]

//dependency strings for use in sub projects
ext.libs = [
    dropwizard_core: "io.dropwizard:dropwizard-core:$versions.dropwizard",
    dropwizard_hibernate: "io.dropwizard:dropwizard-hibernate:$versions.dropwizard",
    jackson_annotations: "com.fasterxml.jackson.core:jackson-annotations:$versions.jackson",
    jackson_core: "com.fasterxml.jackson.core:jackson-core:$versions.jackson",
    jackson_databind: "com.fasterxml.jackson.core:jackson-databind:$versions.jackson", 
    junit: "junit:junit:4.12",
    kafka: "org.apache.kafka:kafka-clients:$versions.kafka", //CDH5.10 uses kafka 10.0, Kafka <10.2 is picky about client and server versions.
    mockito_core: "org.mockito:mockito-core:2.0.2-beta",
    slf4j_api: "org.slf4j:slf4j-api:$versions.slf4j",
    swagger_annotations: "io.swagger:swagger-annotations:$versions.swagger",
    ws_rs_api: "javax.ws.rs:javax.ws.rs-api:2.0.1",
    zzDUMMYzz: "makes sorting easier"
]

buildscript {
    repositories {
        mavenLocal()
        jcenter()
    }
    dependencies {
        classpath 'gchq:urlDependencyPlugin:v0.2.0'
        classpath 'ca.cutterslade.gradle:gradle-dependency-analyze:1.1.0'
        classpath 'com.benjaminsproule:swagger-gradle-plugin:0.1.2'
    }
}


allprojects {
    apply plugin: 'maven'
    apply plugin: 'maven-publish'
    apply plugin: 'gchq.urldependencies'
    apply plugin: 'maven-publish'

    group = 'stroom'
    version = versions.stroomQuery
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'idea'
    sourceCompatibility = 1.8
    targetCompatibility = 1.8

    repositories {
        mavenLocal()
        maven { url "http://repo.maven.apache.org/maven2" }
    }

    dependencies {
        testCompile libs.junit
        testCompile libs.mockito_core
    }

    task sourcesJar(type: Jar, dependsOn: classes) {
        classifier = 'sources'
        from sourceSets.main.allSource
    }

    task javadocJar(type: Jar, dependsOn: javadoc) {
        classifier = 'javadoc'
        from javadoc.destinationDir
    }

    artifacts {
        archives sourcesJar
        archives javadocJar
    }

    publishing {
        publications {
            mavenJava(MavenPublication) {
                artifact sourcesJar
                artifact javadocJar
            }
        }
    }

    //ensure we download our libs before compiling java
    tasks.compileJava.dependsOn ':downloadUrlDependencies'
}

project(':stroom-query-api') {
    publishing {
        publications {
            mavenJava(MavenPublication) {
                from components.java
            }
        }
    }
}

project(':stroom-query-common') {
    publishing {
        publications {
            mavenJava(MavenPublication) {
                from components.java
            }
        }
    }
}

project(':stroom-query-audit') {
    publishing {
        publications {
            mavenJava(MavenPublication) {
                from components.java
            }
        }
    }
}

project(':stroom-query-hibernate') {
    publishing {
        publications {
            mavenJava(MavenPublication) {
                from components.java
            }
        }
    }
}

urlDependencies {
    libs "${libs}"
    compile(
        urlLibs.stroomExpression,
        "https://github.com/gchq/stroom-expression/releases/download/$versions.stroomExpression/${urlLibs.stroomExpression}.jar")
    compile(urlLibs.eventLogging,
            "https://github.com/gchq/event-logging/releases/download/$versions.eventLogging/${urlLibs.eventLogging}.jar")
}

task aggregatedJavadocs(
    type: Javadoc, 
    description: 'Generate javadocs from all child projects as if it was a single project', 
    group: 'Documentation') {

	destinationDir = file("$buildDir/docs/javadoc")
	title = "$project.name $version API"
	options.author true
	options.links 'http://docs.oracle.com/javase/8/docs/api/'
	options.addStringOption 'Xdoclint:none', '-quiet'
	
	subprojects.each { proj ->
		proj.tasks.withType(Javadoc).each { javadocTask ->
			source += javadocTask.source
			classpath += javadocTask.classpath
			excludes += javadocTask.excludes
			includes += javadocTask.includes
		}
	}
}


tasks.build.dependsOn aggregatedJavadocs
